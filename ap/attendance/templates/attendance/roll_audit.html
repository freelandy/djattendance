{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
  {{title}}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script type="text/javascript">

var audit_log = [];
var base_info = [];
var period = parseInt("{{last_period}}");

function make_row(t_id){
  if ($("#"+t_id).length == 0){
    node = document.createElement('tr')
    node.setAttribute('id', t_id)
    $("#audittable").children('tbody').append(node)

    row_length = $("#audittable").children('thead').children().children().length
    for (let k = 0; k < row_length; k++){
      col = document.createElement('td')
      $("#"+t_id).append(col)
    }
  }
}

function render_table(){

  // base_headers = Object.keys(base_info[0][Object.keys(base_info[0])])
  base_headers = ['self_attendance', 'name', 'gender', 'term']
  base_audit = ['mismatch', 'AT_discrepancy', 'details']
  for (let i = 0; i < base_info.length; i++) {
    base_record = base_info[i]
    t_id = Object.keys(base_record)[0]
    make_row(t_id)
    dict = base_record[t_id]
    row = $("#"+t_id)
    for (let j = 0; j < base_headers.length; ++j) {
      let key = base_headers[j]
      let index = ':eq(' + j.toString() + ')'
      row.children(index).html(dict[key].toString())
    }

    audit_record = audit_log[i]
    t_id = Object.keys(audit_record)[0]
    make_row(t_id)
    dict = audit_record[t_id]
    row = $("#"+t_id)
    for (let j = 0; j < base_audit.length; ++j) {
      let key = base_audit[j]
      let index = ':eq(' + (j + base_headers.length).toString() + ')'
      row.children(index).html(dict[key])
    }

    if (Object.keys(dict).length > 3){
      for (let j = 0; j < period+1; ++j) {
        let period_details = dict[j.toString()]
        let index = base_headers.length + base_audit.length + j * base_audit.length
        for (let k = 0; k < base_audit.length; ++k) {
          let index_add = ':eq(' + (index + k).toString() + ')'
          let key = base_audit[k]
          row.children(index_add).html(period_details[key])
        }
      }
    }
  }

  $("#audittable").show()
  $(".image_container").hide()
  setdatatable()

}

function getTraineeAudit(traineeId, url){
  $.ajax({
    type: "GET",
    url: url,
    data: {
      traineeId: traineeId,
    },
    success: function(response){
      console.log(response)
      audit_log.push(response)
      if (audit_log.length == base_info.length){
        setHeaders()
        render_table()
      }

    },
  });
}

function getAuditLog(records, url){

  records.forEach(function(element) {
    traineeId = Object.keys(element)[0]
    getTraineeAudit(traineeId, url);
  });

}

function setdatatable(){
  $("#audittable").DataTable({
      info: false,
      paging: false,
      autoWidth: true,
      columnDefs: [
      {
        targets: '_details',
        visible: false
      },
      {
        targets: '_all',
        visible: true
      }
      ],
      dom: '<"row"<"col-sm-6"Bl><"col-sm-6"f>>' +
      '<"row"<"col-sm-12"<"table-responsive"tr>>>' +
      '<"row"<"col-sm-5"i><"col-sm-7"p>>',
      fixedHeader: {
        header: true
      },
      buttons: [
      {
        extend: 'print',
        text: 'Print',
        autoPrint: true,
        exportOptions:{
          columns: ':visible'
        },
      },
      {
        extend: 'csvHtml5',
        text: 'CSV',
        exportOptions: {
          columns: ':visible'
        },
      },
      {
        extend: 'pdf',
        text: 'PDF',
        exportOptions:{
          columns: ':visible'
        },
      },
      {
        extend: 'collection',
        buttons: 'columnsVisibility',
        text: 'Show/Hide Columns',
        columns: ':gt(1)',
      },
      ],
    });
}

function setHeaders(){
  table_headers = $("#audittable").children('thead').children()
  for (let i = 0; i < period + 1; i++) {
    node = document.createElement('th')
    node.classList.add("_details");
    text = document.createTextNode('Per. ' + i + ' MF')
    node.appendChild(text);
    table_headers.append(node)

    node = document.createElement('th')
    node.classList.add("_details");
    text = document.createTextNode('Per. ' + i + ' A/T Dis.')
    node.appendChild(text);
    table_headers.append(node)

    node = document.createElement('th')
    node.classList.add("_details");
    text = document.createTextNode('Per. ' + i + ' Det.')
    node.appendChild(text);
    table_headers.append(node)
  }

}

$(document).ready(function() {

  $("#audittable").hide()

  base_info = {{ base_info|safe }};
  getAuditLog(base_info, "{% url 'attendance:single-trainee-audit' %}")

  $("body").on('click', 'span.glyphicon',function(){
    var state_tobe;

    if ($(this).attr('class') == 'glyphicon glyphicon-ok-circle'){
      $(this).attr('class', 'glyphicon glyphicon-remove-circle')
      $(this).attr('style', 'color:red')
      state_tobe = false
    }else if($(this).attr('class') == 'glyphicon glyphicon-remove-circle'){
      $(this).attr('class', 'glyphicon glyphicon-ok-circle')
      $(this).attr('style', 'color:green')
      state_tobe = true
    }

    var val = $(this).parent().attr('id');

    $.ajax({
      type: "POST",
      url: "{%url 'attendance:audit-rolls' %}",
      data: {id: val,
        state: state_tobe,
        csrfmiddlewaretoken: '{{ csrf_token }}'},
        success: function(response){
          new Notification(Notification.SUCCESS, 'Saved').show();
        },
      })
  });

});

</script>
{% endblock %}

{% block references %}
{{ block.super }}
<style type="text/css">
/* Container holding the image and the text */
.image_container {
  position: relative;
  text-align: center;
}

/* Centered text */
.centered {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

</style>
{% endblock %}

{% block content %}

<h2>{{title}}</h2>

<div class="image_container">
  <img class="loading-image" src="{% static 'gospel_trips/images/loading.gif' %}"/>
  <div class="centered">Loading</div>
</div>

<table id="audittable" class="table table-striped table-bordered">
  <thead><tr>
    <th>On Self-Attendance</th>
    <th>Trainee</th>
    <th class="_details">Gender</th>
    <th class="_details">Term</th>
    <th>Mismatched Frequencies</th>
    <th>A/T Discrepancy</th>
    <th>Rolls Detail - Text</th>
  </tr></thead>
  <tbody></tbody>
</table>

{% endblock %}