{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
  {{title}}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script type="text/javascript">

var audit_log = [];
var base_info = [];

function render_table(){
  table_body = $("#audittable").children('tbody').children()
  for (var i = 0; i < base_info.length; i++) {
    record = base_info[i]
    node = document.createElement('tr')
    t_id = Object.keys(record)[0]
    node.setAttribute('id', t_id)
    table_body.append(node)
    row = $("#"+t_id).children()
    


  }

  $("#audittable").show()
  $(".image_container").hide()
  setdatatable()

}

function getTraineeAudit(traineeId, url){
  $.ajax({
    type: "GET",
    url: url,
    data: {
      traineeId: traineeId,
    },
    success: function(response){
      console.log(response)
      audit_log.push(response)
      if (audit_log.length == base_info.length){
        setHeaders()
        render_table()
      }

    },
  });
}

function getAuditLog(records, url){

  records.forEach(function(element) {
    traineeId = Object.keys(element)[0]
    getTraineeAudit(traineeId, url);
  });

}

function setdatatable(){
  $("#audittable").DataTable({
      info: false,
      paging: false,
      autoWidth: true,
      columnDefs: [
      {
        targets: 'period_details',
        visible: false
      },
      {
        targets: '_all',
        visible: true
      }
      ],
      dom: '<"row"<"col-sm-6"Bl><"col-sm-6"f>>' +
      '<"row"<"col-sm-12"<"table-responsive"tr>>>' +
      '<"row"<"col-sm-5"i><"col-sm-7"p>>',
      fixedHeader: {
        header: true
      },
      buttons: [
      {
        extend: 'print',
        text: 'Print',
        autoPrint: true,
        exportOptions:{
          columns: ':visible'
        },
      },
      {
        extend: 'csvHtml5',
        text: 'CSV',
        exportOptions: {
          columns: ':visible'
        },
      },
      {
        extend: 'pdf',
        text: 'PDF',
        exportOptions:{
          columns: ':visible'
        },
      },
      {
        extend: 'collection',
        buttons: 'columnsVisibility',
        text: 'Show/Hide Columns',
        columns: ':gt(1)',
      },
      ],
    });
}

function setHeaders(){
  period = parseInt("{{last_period}}");
  table_headers = $("#audittable").children('thead').children()
  for (i = 0; i < period + 1; i++) {
    node = document.createElement('th')
    node.classList.add("period_details");
    text = document.createTextNode('Per. ' + i + ' MF')
    node.appendChild(text);
    table_headers.append(node)

    node = document.createElement('th')
    node.classList.add("period_details");
    text = document.createTextNode('Per. ' + i + ' A/T Dis.')
    node.appendChild(text);
    table_headers.append(node)

    node = document.createElement('th')
    node.classList.add("period_details");
    text = document.createTextNode('Per. ' + i + ' Det.')
    node.appendChild(text);
    table_headers.append(node)
  }

}

$(document).ready(function() {

  $("#audittable").hide()

  base_info = {{ base_info|safe }};
  getAuditLog(base_info, "{% url 'attendance:single-trainee-audit' %}")

  $("body").on('click', 'span.glyphicon',function(){
    var state_tobe;

    if ($(this).attr('class') == 'glyphicon glyphicon-ok-circle'){
      $(this).attr('class', 'glyphicon glyphicon-remove-circle')
      $(this).attr('style', 'color:red')
      state_tobe = false
    }else if($(this).attr('class') == 'glyphicon glyphicon-remove-circle'){
      $(this).attr('class', 'glyphicon glyphicon-ok-circle')
      $(this).attr('style', 'color:green')
      state_tobe = true
    }

    var val = $(this).parent().attr('id');

    $.ajax({
      type: "POST",
      url: "{%url 'attendance:audit-rolls' %}",
      data: {id: val,
        state: state_tobe,
        csrfmiddlewaretoken: '{{ csrf_token }}'},
        success: function(response){
          new Notification(Notification.SUCCESS, 'Saved').show();
        },
      })
  });

});

</script>
{% endblock %}

{% block references %}
{{ block.super }}
<style type="text/css">
/* Container holding the image and the text */
.image_container {
  position: relative;
  text-align: center;
}

/* Centered text */
.centered {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

</style>
{% endblock %}

{% block content %}

<h2>{{title}}</h2>

<div class="image_container">
  <img class="loading-image" src="{% static 'gospel_trips/images/loading.gif' %}"/>
  <div class="centered">Loading...</div>
</div>

<table id="audittable" class="table table-striped table-bordered">
  <thead><tr>
    <th>On Self-Attendance</th>
    <th>Trainee</th>
    <th class="period_details">Gender</th>
    <th>Mismatched Frequencies</th>
    <th>A/T Discrepancy</th>
    <th>Rolls Detail - Text</th>
  </tr></thead>
  <tbody></tbody>
</table>

{% endblock %}